# ------------------------------------------------
# NGINXのメイン設定 (eventsブロックは必須)
# ------------------------------------------------
events {
    # ワーカプロセスが同時に処理できる接続数を設定
    worker_connections 1024;
}

# ------------------------------------------------
# Http通信の設定
# ------------------------------------------------
# 1. httpブロックの外側（通常は /etc/nginx/nginx.conf の main コンテキスト）
# proxy_cache_path ディレクティブは http コンテキストまたは main コンテキストに記述します。
# 便宜上、ここでは http ブロック内に記述します。
http {
   # キャッシュ保存先ディレクトリと設定を定義
   # /var/cache/nginx/my_cache に保存し、キーは10MB、保存領域は1GB、ファイルは7日間保持
   proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=7d;

    server {
        # ポート番号
        listen 80;

        # サーバー名
        server_name localhost;

        # リクエストのルーティング設定
       location / {
           proxy_pass http://app1:80;

           # 2. リバースプロキシ設定内でキャッシュを有効化
           proxy_cache my_cache; # keys_zoneで定義した名前を指定

           # キャッシュの有効期間を定義 (ここでは1時間)
           proxy_cache_valid 200 1h;

           # Cache-Control, Set-Cookie, Expires ヘッダーを完全に無視させる
           # これらがバックエンドから返されても、Nginxはキャッシュを保存・利用する
           proxy_ignore_headers Cache-Control Expires Set-Cookie;

           # リクエストに含まれるキャッシュ制御ヘッダー（no-cacheなど）を無視する
           # Nginxのキャッシュ設定を強制
           proxy_cache_bypass 0;
           proxy_no_cache 0;

           # 💡 追記: キャッシュの更新時に、バックエンドサーバーのetag/last-modifiedを無視
           proxy_cache_revalidate off;

           # レスポンスヘッダーにキャッシュの状態（HIT/MISS）を追加
           add_header X-Cache-Status $upstream_cache_status;
       }
    }
}