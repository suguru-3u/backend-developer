# ------------------------------------------------
# NGINXã®ãƒ¡ã‚¤ãƒ³è¨­å®š (eventsãƒ–ãƒ­ãƒƒã‚¯ã¯å¿…é ˆ)
# ------------------------------------------------
events {
    # ãƒ¯ãƒ¼ã‚«ãƒ—ãƒ­ã‚»ã‚¹ãŒåŒæ™‚ã«å‡¦ç†ã§ãã‚‹æ¥ç¶šæ•°ã‚’è¨­å®š
    worker_connections 1024;
}

# ------------------------------------------------
# HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
# ------------------------------------------------
http {
    # 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿å­˜å ´æ‰€ã¨è¨­å®š (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
    # /data/nginx/cache ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã€æœ€å¤§1GBã¾ã§ä½¿ç”¨
    # Docker Composeã§å®šç¾©ã•ã‚ŒãŸãƒœãƒªãƒ¥ãƒ¼ãƒ åã¨åˆã‚ã›ã‚‹
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m use_temp_path=off;

    # $uriï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆURIï¼‰ã«åŸºã¥ã„ã¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã‹ (1) ã—ãªã„ã‹ (0) ã‚’æ±ºå®šã—ã¾ã™ã€‚
    # map $uri $should_cache {
        # default         0;  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªAPIã‚„èªè¨¼ãŒå¿…è¦ãªã‚‚ã®)

        # ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«å®Œå…¨ã«ä¸€è‡´ã€ã¾ãŸã¯ä»¥ä¸‹ã®ãƒ‘ã‚¹ã‹ã‚‰å§‹ã¾ã‚‹å ´åˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨±å¯ (1)
        # ä¾‹: /api/public/data/123 ãªã©
        # ~^/api/articles/*   1;

        # ç‰¹å®šã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã ã‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å ´åˆã®ä¾‹
        # ~^/api/items/list$ 1;
    # }

    server {
        listen 80;
        server_name example.com;

        # ğŸ’¡ Nginxã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ«ãƒ¼ãƒˆ (Docker Composeã§ãƒã‚¦ãƒ³ãƒˆã—ãŸ ./front)
        root /usr/share/nginx/html;

        # 2. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š (å¼·ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
        location ~* ^/static/.*(css|js|jpg|png|gif|ico)$ {
            # ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ:
            # 1. Nginxã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹æ¢ã™
            # 2. ãªã‘ã‚Œã°ã€åå‰ä»˜ããƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ @app_proxy ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ã™ã‚‹
            try_files $uri @app_proxy;

            # Nginxã§é…ä¿¡ã§ãã‚‹å ´åˆã¯ã€ã“ã“ã§å¼·ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸
            expires 1y;
            log_not_found off;
            add_header Cache-Control "public, max-age=60";
        }

        # 3. ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ / ã¯ index.html ã‚’æ¢ã™ã‹ã€/api/ ä»¥å¤–ã‚’ app ã«è»¢é€ã™ã‚‹
        location / {
            # 1. Nginxã®rootï¼ˆ/usr/share/nginx/html/ï¼‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            # 2. ãªã‘ã‚Œã° @app_proxy ã«è»¢é€
            try_files $uri $uri/ @app_proxy;
        }

        # 4. @app_proxy: Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ»APIãƒ»è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰
        location @app_proxy {
            proxy_pass http://app:8080;
            proxy_set_header Host $host;
            proxy_set_header Connection "";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 5. APIã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ /api/ ãƒ‘ã‚¹ã«é™å®š
        location /api/ {
            proxy_pass http://app:8080;

            # $should_cache å¤‰æ•°ãŒ 0 ã®å ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
            # proxy_cache_bypass $should_cache;
            # proxy_no_cache $should_cache;

            proxy_cache api_cache;

            proxy_set_header If-None-Match $http_if_none_match;
            proxy_set_header If-Modified-Since $http_if_modified_since;
        }
    }
}